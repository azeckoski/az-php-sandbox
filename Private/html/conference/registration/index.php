<?php/* * Created on March 13, 2006 by @author aaronz * Aaron Zeckoski (aaronz@vt.edu) - Virginia Tech (http://www.vt.edu/) */?><?phprequire_once '../include/tool_vars.php';$PAGE_NAME = "Registration";$Message = "";// connect to databaserequire '../sql/mysqlconnect.php';// check authenticationrequire $ACCOUNTS_PATH.'include/check_authentic.php';// login if not autheticated$AUTH_MESSAGE = "You must login to register for the $CONF_NAME conference. If you do not have an account, please create one.";require $ACCOUNTS_PATH.'include/auth_login_redirect.php';// bring in the form validation coderequire $ACCOUNTS_PATH.'ajax/validators.php';// bring in inst and conf datarequire 'includes/getInstConf.php';// get the passed message if there is oneif($_GET['msg']) {	$Message .= "<br/>" . $_GET['msg'];}// add in the help link//$EXTRA_LINKS = " - <a style='font-size:9pt;' href='$HELP_LINK' target='_HELP'>Help</a><br/>";//$EXTRA_MESSAGE = "<br/><span style='font-size:8pt;'>Technical problems? Please contact <a href='mailto:$HELP_EMAIL'>$HELP_EMAIL</a></span><br/>";?><?php include $ACCOUNTS_PATH.'include/top_header.php'; // INCLUDE THE HTML HEAD ?><script type="text/javascript" src="/accounts/ajax/validate.js"></script><?php include '../include/header.php'; // INCLUDE THE HEADER ?><table width="100%" class="blog" cellpadding="0" cellspacing="0">  <tr>    <td valign="top"><div class="componentheading">Sakai Conference Registration</div></td>  </tr></table><?php// writing data and other good things happen hereif ($_POST['save']) { // saving the form	$errors = 0;// TODO - DO SERVER SIDE VALIDATION	// get the post variables - USER	$address1 = mysql_real_escape_string($_POST["address1"]);	$city = mysql_real_escape_string($_POST["city"]);	$state = mysql_real_escape_string($_POST["state"]);	$zip = mysql_real_escape_string($_POST["zip"]);	$country = mysql_real_escape_string($_POST["country"]);	$phone = mysql_real_escape_string($_POST["phone"]);	$fax = mysql_real_escape_string($_POST["fax"]);	// get the post variables - CONF	$otherInst = mysql_real_escape_string($_POST["otherInst"]);	$title = mysql_real_escape_string($_POST["title"]);	$shirt = mysql_real_escape_string($_POST["shirt"]);	$special = mysql_real_escape_string($_POST["special"]);	$hotelInfo = mysql_real_escape_string($_POST["hotelInfo"]);	$jasig = mysql_real_escape_string($_POST["jasig"]);	$contactInfo = mysql_real_escape_string($_POST["publish"]);	$delegate = mysql_real_escape_string($_POST["delegate"]);	// other vars	$institution = $INST['name'];	$activated = "";		// TODO - SAVE THE CURRENT DATA IN THE DATABASE	if ($errors == 0) {		// write the data to the database				// update the user information first		$usersql = "UPDATE users SET address='$address1', city='$city', state='$state', " .			"zipcode='$zip', country='$country', phone='$phone', fax='$fax' where pk='$USER_PK'";		$result = mysql_query($usersql) or die('User update query failed: ('.$usersql.')' . mysql_error());		$new_req = false;		if (!$isRegistered) { // no conference record for this user and this conference			// calculate the fee			$fee = 0;			if (!$isPartner) {				if ($jasig == 'Y') {					$fee = 345;				} else {					$fee = 395;				}			}			// insert a new entry for the conference			$confsql = "INSERT INTO sakaiConf_all (confID, institution, otherInst, " .				"title, shirt, special, hotelInfo, jasig, contactInfo, " .				"fee, delegate, activated, users_pk) VALUES " .				"('$CONF_ID', '$institution', '$otherInst', " .				"'$title', '$shirt', '$special', '$hotelInfo', '$jasig', '$contactInfo', " .				"'$fee', '$delegate', '$activated', $USER_PK)";			$result = mysql_query($confsql) or die('Conf insert query failed: ('.$confsql.')' . mysql_error());			$new_req = true;		} else {			// update the existing entry			$confsql = "UPDATE sakaiconf_all SET institution='$institution', " .				"otherInst='$otherInst', shirt='$shirt', special='$special', " .				"hotelInfo='$hotelInfo', jasig='$jasig', " .				"title='$title', delegate='$delegate', contactInfo='$contactInfo' WHERE " .				"users_pk='$USER_PK' and confID='$CONF_ID'";			$result = mysql_query($confsql) or die('Conf update query failed: ('.$confsql.')' . mysql_error());		}				// refresh the USER and CONF arrays in case anything changed and to get the new conf data		// for the newly created registration		// get updated user information		$user_sql = "select * from users where pk='$USER_PK'";		$result = mysql_query($user_sql) or die('User fetch query failed: ' . mysql_error());		$USER = mysql_fetch_assoc($result); // first result is all we care about				// get the new conf info for this user		$conf_sql = "select * from sakaiConf_all where users_pk='$USER_PK' and confID='$CONF_ID'";		$result = mysql_query($conf_sql) or die('Conf fetch query failed: ' . mysql_error());		$CONF = mysql_fetch_assoc($result); // first result is all we care about		// draw confirmation page or send to payment page		if ($isPartner || $CONF['transID']) {			// draw the confirmation page			$SEND_EMAIL = $new_req;			require 'includes/member_confirmation.php';			// send the registration email if this is a new registration			if ($new_req) {				require 'includes/email_confirmation.php';			}		} else {			// to payment page IF they have not already paid (no transID)			header("Location:payment.php");  //begin VerisignPayment process		}		exit();	}}?><?php	// this should never happen but just in case	if (!$USER['institution_pk']) {		print "<b style='color:red;'>Fatal Error: You must use the My Account link to set " .			"your institution before you can fill out your conference registration.</b>";	} else {		// allow registration?><?php echo $Message; ?><!-- start of the form td --><div id=cfp><br /> <!-- start form section --><form name="<?= $formID ?>" id=form1 method="post" action="<?= $_SERVER['PHP_SELF']."?formid=$formID" ?>"><input type="hidden" name="save" value="1" /><table width="500px"  cellpadding="0" cellspacing="0"><tr>	<td valign="top" colspan="2" style="padding:0px;">		<div id="requiredMessage"></div>	</td></tr><tr>	<td colspan=2>		<strong>Verify personal information:</strong><br />		<div style="padding-left: 40px;"><?php	// get info for verification	echo "<b>Name:</b> " . $USER['firstname'] . " " . $USER['lastname'] . "<br>";	echo "<b>Email:</b> " . $USER['email'] . "<br>";	echo "<b>Institution:</b> " . $INST['name'] . "<br>";?>      <div style="margin:10px;"></div><?php	if ($isPartner) {  // this means the user is in a partner inst ?>	<strong><?= $INST['name'] ?> is a Sakai Partner Organization</strong> (registration fee is waived)	<input type="hidden" name="memberType" value="1" />	<input type="hidden" name="institution" value="<?= $INST['name'] ?>" /><?php } else { // this is a member institution ?>	<strong><?= $INST['name'] ?> is not a Sakai Partner Organization</strong>&nbsp;	<input type="hidden" name="memberType" value="2" />	<br/>      <div style="margin:10px;"></div>      <strong>Registration Fee:</strong> $395 per person. <br />      <i>If you are also attending the JA-SIG/uPortal conference, your fee will be $345</i><br />      <div style="margin:6px;"></div>      Visa, Mastercard, and American express accepted<br />      <img src="includes/images/ccards.jpg" width="121px" height="30px"><?php } ?>	<div style="margin:10px;"></div>	If the above information is wrong, use the 	<a href="<?= $ACCOUNTS_URL ?>/<?= $ACCOUNTS_PAGE ?>" target="_account">My Account</a>	page to correct it		</div>	</td></tr><?php/*******************************///print forms/*******************************///combined forms to get user informationinclude("includes/attendee.php");include("includes/otherInfo.php");?><?php if ($isPartner) { ?>    <tr>      <td colspan=2><div align=center>          <input id="submitbutton" type="submit" name="submit_MemberReg" value="Save my registration" />        </div></td>    </tr><?php  } else { ?>    <tr>      <td colspan=2><div align=center>          <input id="submitbutton" type="submit" name="submit_NonMemberReg" value="Save and continue" />        </div></td>    </tr><?php  } ?>  </table></form><!--end of unique form info for form1 --></div> <!-- end cfp --><?php } ?><?php include '../include/footer.php'; // Include the FOOTER ?>