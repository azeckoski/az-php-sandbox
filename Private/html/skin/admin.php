<?php/* * Created on March 2, 2006 by @author aaronz * Aaron Zeckoski (aaronz@vt.edu) - Virginia Tech (http://www.vt.edu/) */?><?phprequire_once 'include/tool_vars.php';$PAGE_NAME = "Admin Control";$Message = "";// connect to databaserequire 'sql/mysqlconnect.php';// check authenticationrequire $ACCOUNTS_PATH.'include/check_authentic.php';// login if not autheticatedrequire $ACCOUNTS_PATH.'include/auth_login_redirect.php';$allowed = 0; // assume user is NOT allowed unless otherwise shownif (!$User->checkPerm("admin_skin")) {	$allowed = 0;	$Message = "Only admins with <b>admin_skin</b> may view this page.<br/>" .		"Try out this one instead: <a href='$TOOL_URL/'>$TOOL_NAME</a>";} else {	$allowed = 1;}// Do the export as requested by the userif ($_REQUEST["export_insts"] && $allowed) {	$date = date("Ymd-Hi",time());	$filename = "institutions-" . $date . ".csv";	header("Content-type: text/x-csv");	header("Content-disposition: inline; filename=$filename\n\n");	header("Cache-Control: must-revalidate, post-check=0, pre-check=0");	header("Expires: 0"); 		// generate the export file	$export_sql = "select I1.name, I1.abbr, I1.type, U1.username, U1.firstname, U1.lastname, U1.email,count(RV.pk) as official_votes from institution I1 left join users U1 on U1.pk=I1.repvote_pk left join requirements_vote RV on RV.users_pk=U1.pk and RV.round='$ROUND' and RV.official='1'group by I1.name, RV.users_pk";	$result = mysql_query($export_sql) or die('Export query failed: ' . mysql_error());	$line = 0;	while($itemrow=mysql_fetch_assoc($result)) {		$line++;		// print out EXPORT format instead of display		if ($line == 1) {			print "\"Institutions and Reps Export\"\n";			print join(',', array_keys($itemrow)) . "\n"; // add header line		}				foreach ($itemrow as $name=>$value) {			$value = str_replace("\"", "\"\"", $value); // fix for double quotes			$itemrow[$name] = '"' . $value . '"'; // put quotes around each item		}		print join(',', $itemrow) . "\n";	}		// add extra stuff at the bottom	print "\n\"Exported on:\",\"" . date($DATE_FORMAT,time()) . "\"\n";		print "\"Voting round:\",\"" . $ROUND . "\"\n";		exit;}$EXTRA_LINKS = "<br><span style='font-size:9pt;'><strong>Skin Admin</strong></span>";?><?php include $ACCOUNTS_PATH.'include/top_header.php'; ?><script><!--// --></script><?php include 'include/header.php'; ?><?= $Message ?><?php	// This part will punt the user out if they are not allowed	if (!$allowed) {		include 'include/footer.php';		exit;	}?><?php// process form actions?><strong><?= $TOOL_NAME ?> Admin Operations</strong><br/><div style="margin:6px;"></div><form name="adminform" method="post" action="<?=$_SERVER['PHP_SELF']; ?>" style="margin:0px;"></form><?php include 'include/footer.php'; // Include the FOOTER ?>