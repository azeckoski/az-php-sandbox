<?php	require_once ("tool_vars.php");	// Form to allow user to vote	$PAGE_NAME = "Voting Form";	// connect to database	require "mysqlconnect.php";	// get the passkey from the cookie if it exists	$PASSKEY = $_COOKIE["SESSION_ID"];	// check the passkey	$USER_PK = 0;	if (isset($PASSKEY)) {		$sql1 = "SELECT users_pk FROM sessions WHERE passkey = '$PASSKEY'";		$result = mysql_query($sql1) or die('Query failed: ' . mysql_error());		$row = mysql_fetch_assoc($result);		if( !$result ) {			// no valid key exists, user not authenticated			$USER_PK = -1;		} else {			// authenticated user			$USER_PK = $row["users_pk"];		}		mysql_free_result($result);	}	if( $USER_PK <= 0 ) {		// no user_pk, user not authenticated		// redirect to the login page		header('location:'.$ACCOUNTS_PATH.'login.php?ref='.$TOOL_PATH.'/vote.php');		exit;	}	// if we get here, user should be authenticated	// get the authenticated user information	$authsql = "SELECT * FROM users WHERE pk = '$USER_PK'";	$result = mysql_query($authsql) or die('Query failed: ' . mysql_error());	$USER = mysql_fetch_assoc($result);?><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"><title><?= $TOOL_NAME ?> - <?= $PAGE_NAME ?></title><link href="./requirements_vote.css" rel="stylesheet" type="text/css"><script><!--function focus(){document.filter.searchtext.focus();}function getSelectedRadio(buttonGroup) {   // returns the array number of the selected radio button or -1 if no button is selected   if (buttonGroup[0]) { // if the button group is an array (one button is not an array)      for (var i=0; i<buttonGroup.length; i++) {         if (buttonGroup[i].checked) {            return i         }      }   } else {      if (buttonGroup.checked) { return 0; } // if the one button is checked, return zero   }   // if we get to this point, no radio button is selected   return -1;}function checkSaved(num) {	// Get current vote for this item	var voteItem = document.getElementById('vh'+num);	var curVote = voteItem.value;	// Get current selection	var rbuttons = document.getElementsByName('vr'+num);	var curSelect = getSelectedRadio(rbuttons);	curSelect = 3 - curSelect; // make it line up with the radio buttons	document.voteform.debugtest.value='CKS:' + num + ':' + curVote + ':' + curSelect;	// Compare values	if (curVote >= 0) {		if (curVote == curSelect) {			setSaved(num);		} else {			setUnsaved(num);		}	} else {		// no vote saved for this item		setUnsaved(num);	}}function setUnsaved(num) {	var item = document.getElementById('vb'+num);	item.className='unsaved';	var sbutton = document.getElementById('vs'+num);	sbutton.disabled=false;	var cbutton = document.getElementById('vc'+num);	cbutton.disabled=false;	//document.voteform.debugtest.value='UNS:' + item;}function setSaved(num) {	var item = document.getElementById('vb'+num);	item.className='saved';	var sbutton = document.getElementById('vs'+num);	sbutton.disabled=true;	var cbutton = document.getElementById('vc'+num);	cbutton.disabled=true;	//document.voteform.debugtest.value='SAV:' + item;}function setCleared(num) {	// get current vote	var voteItem = document.getElementById('vh'+num);	var curVote = voteItem.value;	// reset radio buttons	var rbuttons = document.getElementsByName('vr'+num);	for (i=0;i<rbuttons.length;i++) {		rbuttons[i].checked=false;		document.voteform.debugtest.value='CLR:' + curVote;		if (i == (3 - curVote)) {			rbuttons[i].checked=true;		}	}	// reset style if not returning to saved vote	if (curVote < 0) {		var item = document.getElementById('vb'+num);		item.className='clear';		var sbutton = document.getElementById('vs'+num);		sbutton.disabled=true;		var cbutton = document.getElementById('vc'+num);		cbutton.disabled=true;	} else {		// reset to saved value		setSaved(num);	}}// --></script></head><body onLoad="focus();"><? // Include the HEADER -AZinclude 'header.php'; ?><?php	//processing the posted values for saving	$Keys = array();	$Keys = array_keys($_POST);	foreach( $Keys as $key)	{		$check = strpos($key,'vr');		if ( $check !== false && $check == 0 ) {			$item_pk = substr($key, 2);			$value = $_POST[$key];			//print "key=$key : item_pk=$item_pk : value=$value <br/>";			// Check to see if this vote already exists			$check_exists_sql="select pk, vote from requirements_vote where " .				"users_pk='$USER_PK' and req_data_pk='$item_pk'";			$result= mysql_query($check_exists_sql) or die('Query failed: ' . mysql_error());			if ($result) {				// vote exists, now see if it changed				// vote changed so write update				// vote not changed so continue			} else {				// vote does not exist, insert it				$insert_vote_sql="insert into requirements_vote (users_pk,req_data_pk,vote) values " .					"('$USER_PK','$item_pk','$value')";				$result= mysql_query($insert_vote_sql) or die('Query failed: ' . mysql_error());			}		}	}	// fetching all requirements data items	$sql="Select * from requirements_data";	$result= mysql_query($sql) or die('Query failed: ' . mysql_error());?>  <div style="background:#ECECEC;border:1px solid #ccc;padding:3px;"><FORM ACTION="vote.php" METHOD="GET" name="filter" style="margin:0px;"><strong> Filter: </strong> &nbsp;&nbsp;<select name="type">                <option value="">-- voting status --</option>                <option value="all">show all items</option>                <option value="done">show all items I've voted on</option>                <option value="open">show all items I need to vote on</option>                    <option value="show_critical"                                > show items I've marked as Critical </option>                   <option value="show_essential"                                > show items I've marked as Essential </option>                    <option value="show_desirable"                                > show items I've marked as Desirable</option>                    <option value="show_na"                                > show items I've marked as  Not Applicable </option>            </select>&nbsp; &nbsp;    <select  name="components"  id="components">                    <option value="">-- component type --</option>                <option value="all"                        >show all components</option>                            <option value="10360" title=" New Tool "                                > New Tool</option>                    <option value="10290" title="Account  "                                >Account </option>                    <option value="10291" title="Aliases (Admin Site Management) "                                >Aliases (Admin Site Management)</option>                    <option value="10292" title="Announcements  "                                >Announcements </option>                    <option value="10293" title="Assignments  "                                >Assignments </option>                    <option value="10294" title="Attachment Widget  "                                >Attachment Widget </option>                    <option value="10295" title="CRUD  "                                >CRUD </option>                    <option value="10296" title="Calendar Widget  "                                >Calendar Widget </option>                    <option value="10297" title="Chat Room  "                                >Chat Room </option>                    <option value="10298" title="Database  "                                >Database </option>                    <option value="10299" title="Discussion  "                                >Discussion </option>                    <option value="10300" title="Documentation (other than Help) "                                >Documentation (other than Help)</option>                    <option value="10301" title="Drop box  "                                >Drop box </option>                    <option value="10302" title="E-mail Archive "                                >E-mail Archive</option>                    <option value="10303" title="Gateway  "                                >Gateway </option>                    <option value="10304" title="Global  "                                >Global </option>                    <option value="10305" title="Gradebook  "                                >Gradebook </option>                    <option value="10306" title="Help  "                                >Help </option>                    <option value="10307" title="Home  "                                >Home </option>                    <option value="10308" title="Install  "                                >Install </option>                    <option value="10309" title="JSF  "                                >JSF </option>                    <option value="10310" title="Licensing  "                                >Licensing </option>                    <option value="10311" title="MOTD  "                                >MOTD </option>                    <option value="10312" title="Membership  "                                >Membership </option>                    <option value="10313" title="Memory (Admin Site Management) "                                >Memory (Admin Site Management)</option>                    <option value="10314" title="My Workspace  "                                >My Workspace </option>                    <option value="10315" title="News (RSS) "                                >News (RSS)</option>                    <option value="10316" title="OSIDs  "                                >OSIDs </option>                    <option value="10317" title="On-Line (Admin Site Management) "                                >On-Line (Admin Site Management)</option>                    <option value="10318" title="Page Wrapper Widget  "                                >Page Wrapper Widget </option>                    <option value="10319" title="Permission Widget  "                                >Permission Widget </option>                    <option value="10320" title="Portal  "                                >Portal </option>                    <option value="10321" title="Preferences  "                                >Preferences </option>                    <option value="10322" title="Presence  "                                >Presence </option>                    <option value="10323" title="Presentation  "                                >Presentation </option>                    <option value="10324" title="Profile  "                                >Profile </option>                    <option value="10325" title="Providers  "                                >Providers </option>                    <option value="10326" title="Quartz Scheduler  "                                >Quartz Scheduler </option>                    <option value="10327" title="Realms (Admin Site Management) "                                >Realms (Admin Site Management)</option>                    <option value="10328" title="Resources  "                                >Resources </option>                    <option value="10329" title="Roster  "                                >Roster </option>                    <option value="10330" title="Rwiki  "                                >Rwiki </option>                    <option value="10331" title="SUTool  "                                >SUTool </option>                    <option value="10332" title="Sakai APIs  "                                >Sakai APIs </option>                    <option value="10333" title="Sakai Application Framework  "                                >Sakai Application Framework </option>                    <option value="10334" title="Samigo - Authoring  "                                >Samigo - Authoring </option>                    <option value="10335" title="Samigo - Delivery  "                                >Samigo - Delivery </option>                    <option value="10336" title="Samigo - Global  "                                >Samigo - Global </option>                    <option value="10337" title="Samigo - Grading  "                                >Samigo - Grading </option>                    <option value="10338" title="Samigo - Question Pools  "                                >Samigo - Question Pools </option>                    <option value="10339" title="Samigo - Templates  "                                >Samigo - Templates </option>                    <option value="10340" title="Schedule  "                                >Schedule </option>                    <option value="10341" title="Section Info  "                                >Section Info </option>                    <option value="10342" title="Site Archive (Admin Site Management)  "                                >Site Archive (Admin Site Management) </option>                    <option value="10343" title="Site Info  "                                >Site Info </option>                    <option value="10344" title="Sites (Admin Site Management)  "                                >Sites (Admin Site Management) </option>                    <option value="10345" title="Sites (Gateway) "                                >Sites (Gateway)</option>                    <option value="10346" title="Skins (CSS) "                                >Skins (CSS)</option>                    <option value="10347" title="Style Guide  "                                >Style Guide </option>                    <option value="10348" title="Syllabus  "                                >Syllabus </option>                    <option value="10349" title="Tab Management  "                                >Tab Management </option>                    <option value="10350" title="Tests &amp; Quizzes (Samigo) "                                >Tests &amp; Quizzes (Samigo)</option>                    <option value="10351" title="Twin Peaks  "                                >Twin Peaks </option>                    <option value="10353" title="Users (Admin User Management) "                                >Users (Admin User Management)</option>                    <option value="10354" title="WYSIWYG Widget  "                                >WYSIWYG Widget </option>                    <option value="10355" title="Web Content  "                                >Web Content </option>                    <option value="10356" title="Web Services  "                                >Web Services </option>                    <option value="10357" title="WebDAV  "                                >WebDAV </option>                    <option value="10358" title="Worksite Information  "                                >Worksite Information </option>                    <option value="10359" title="Worksite Setup  "                                >Worksite Setup </option>            </select> <select  name="audience"  id="audience">                     <option value="">-- audience --</option>                <option value="all"                        >show all audiences</option>                            <option value="10360" title="Students "                                > Students</option>                    <option value="10290" title="Instructors  "                                >Instructors </option>                    <option value="10291" title="Researchers "                                >Researchers</option>                    <option value="10292" title="Staff(administrative)  "                                >Announcements </option>                    <option value="10293" title="Sakai administrators  "                                >Sakai Administrators </option>                    <option value="10294" title="Sakai developers  "                                >Sakai Developers </option>               </select>&nbsp; &nbsp;            <!--audience -->        <input type="text" name="searchtext" length="20">        <input type="submit" name="search" value="Search">	</FORM>	</div><br/><form name="voteform" method="post" action="vote.php" style="margin:0px;"><input type="text" name="debugtest" size="100"><table width=100% border=0 cellspacing=0><tr class='tableheader'><td width='10%'>&nbsp;VOTE</td><td width='5%' align="center">Req#</td><td width='35%'>Summary</td><td width='50%'>Description</td></tr><?phpwhile($links=mysql_fetch_array($result)) {	$line++;	$pk=$links["pk"];	$key=$links["jirakey"];	$summary=$links["summary"];	$description=$links["description"];	$audience=$links["audience"];	$component=$links["component"];	$toolname=$links["toolname"];	$need=$links["need"];	$timeframe=$links["timeframe"];	$linestyle = "oddrow";	if ($line % 2 == 0) {		$linestyle = "evenrow";	} else {		$linestyle = "oddrow";	}	/**	Should set the class of the TD depending on the state of that item -AZ	saved = item has been voted on and saved	unsaved = item has changed	clear = item has no items selected (may have been saved already)	Clear button should be disabled for saved items, Save button should be disabled for saved items	vote should be set to -1 if there is no vote for this user for this item	**/	// voting check	$vote = -1;	$checked = array("","","","","");	//$disableClear = " disabled='y' ";	//$disableSubmit = " disabled='y' ";	if ($vote <= 0) {		// item has not been voted on and saved	} else {		// item has been voted on and saved		$checked[$vote] = " checked='y' ";	}?>	<tr id="<?= $linestyle ?>" valign="top">		<td id="vb<?= $pk ?>" nowrap='y' style='border-right:1px dotted #ccc;border-bottom:1px solid black;' rowspan="2">			<input name="vr<?= $pk ?>" type="radio" value="3" <?= $checked[3] ?>				onClick="checkSaved('<?= $pk ?>')">critical<br />			<input name="vr<?= $pk ?>" type="radio" value="2" <?= $checked[2] ?>				onClick="checkSaved('<?= $pk ?>')">essential<br />			<input name="vr<?= $pk ?>" type="radio" value="1" <?= $checked[1] ?>				onClick="checkSaved('<?= $pk ?>')">desirable<br />			<input name="vr<?= $pk ?>" type="radio" value="0" <?= $checked[0] ?>				onClick="checkSaved('<?= $pk ?>')">not&nbsp;applicable&nbsp;<br />			<br/>			<input id="vh<?= $pk ?>" type="hidden" name="cur<?= $pk ?>" value="<?= $vote ?>">			<input id="vc<?= $pk ?>" type="button" value="Clear" onClick="setCleared('<?= $pk ?>')" disabled='y'>			<input id="vs<?= $pk ?>" type="submit" name="submit" value="Save" disabled='y'>		</td>		<td nowrap='y'>			&nbsp;			<a href='<?= $JIRA_REQ ?><?= $key ?>' title='link to Jira requirement <?= $key ?>'><?= $key ?></a>			&nbsp;		</td>		<td><?= $summary ?></td>		<td rowspan="2" style="padding:2px;border-bottom:1px solid black;">			<?= $description ?>		</td>	</tr>	<tr id="<?= $linestyle ?>" valign="top">		<td colspan="2" style="border-bottom:1px solid black;">			<table>			<tr>				<td align=right><b>Component:</b></td>				<td align="left"><?= $component ?></td>			</tr>			<tr>				<td align=right><b>Audience:</b></td>				<td align="left"><?= $audience ?></td>			</tr>			<tr>				<td align=right><b>Timeframe:</b></td>				<td align="left"><?= $timeframe ?></td>			</tr>			</table>		</td>	</tr><?php } //end of while ?></table></form><?php // Include the FOOTER -AZinclude 'footer.php'; ?></body></html>